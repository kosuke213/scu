# 実装計画（イテレーション1）

## 目的
- 要件定義に基づき、Windows API に依存しないコアロジックを Python で整備する。
- 設定保存、セッション制御、ファイル命名といったドメイン部分をテストで保証する。

## スコープ
- `requirements.md` の AT-01, AT-02, AT-05, AT-09, AT-10 の前提条件を満たすための基盤づくり。
- Windows 固有処理（スクリーンショット取得、キー送出、ホットキー監視）は抽象化のみ。

## タスク分解
1. **設定スキーマ & 永続化**
   - データクラスで `AppConfig` を定義し、バリデーションを実装。
   - JSON 保存 / 読込、および複数テンプレートの管理を行う `ConfigRepository` を実装。
2. **出力パス管理**
   - `SessionPathManager` で保存先ディレクトリの検証とセッションごとのサブフォルダ作成。
   - ファイル命名規則 (`session_YYYYMMDD_HHMMSS/page_XXXX`) を実装し、重複があればインクリメント。
3. **イベントモデル**
   - 進捗、警告、エラーを表すドメインイベントを定義。
   - ロガーや GUI に転送できる JSON シリアライズ可能な形にする。
4. **セッションコントローラ**
   - `start`, `pause`, `resume`, `stop` の状態遷移と、進捗更新ロジックを実装。
   - 手動停止やエラー停止を区別する。
5. **実行パイプライン**
   - キャプチャ、入力、待機の抽象インターフェイスを定義。
   - 処理順序 (`shot-first`, `key-first`) と待機モード（固定ディレイ / 画面変化待ち）を制御するループ処理を記述。
   - 画面変化待ちは差分チェック関数を抽象に委ねる。
6. **テスト**
   - 設定の保存 / 読込、テンプレート切替のテスト。
   - ファイル命名とセッションパス生成のテスト。
   - セッション状態遷移と進捗イベントのテスト。
   - パイプラインの処理順序や待機モードをモックサービスでテスト。

## 期待成果
- Windows ネイティブ実装を追加すれば受入テストに近づける構造が完成。
- 今後のイテレーションで GUI / ネイティブ層を追加する際の API が明確になる。

## リスク
- 実際の Windows API 連携で追加要件が判明する可能性。
- 画面変化検知アルゴリズムの性能は仮定段階。
- 高 DPI 対応はネイティブ層に依存するため、別途検証が必要。

## 次のステップ
- ネイティブ実装の PoC を作成し、Python 側インターフェイスに適合させる。
- GUI プロトタイプでイベントフローを接続し、ホットキー動作を検証する。
