# 要件定義書：マルチモニタ連続スクリーンショット＆矢印キー送出ユーティリティ

## 1. 目的（Goal）
Windows 10/11 環境で、指定モニタ上のアクティブウィンドウまたはモニタ全体を対象に連続スクリーンショットを取得し、各撮影タイミングで左右いずれかの矢印キーを送出してページ送りを自動化する。保存先や処理順序、待機方法を細かく制御でき、ローカル完結で運用可能なユーティリティを提供する。

## 2. スコープ（In/Out）
- **対象 OS**: Windows 10 / 11 (64bit)
- **対象表示環境**: マルチモニタ（最少 2 台）、Per-Monitor DPI 対応
- **対象操作**: ←/→ キーの送出、スクリーンショット取得
- **対象ウィンドウ**: ユーザーが前面に出した任意アプリのウィンドウ、またはモニタ全体
- **非対象**: DRM 解除や暗号化解除、アプリ固有 API 連携、ネットワーク同期

## 3. 利用シナリオ（User Stories）
1. モニタ2のアクティブウィンドウを 0.8 秒間隔で 100 回撮影し、各回で → キーを送出する。保存先は `D:\Capture\Run01`。
2. モニタ1の全画面領域を 20 回、撮影→送出（shot-first）順で実行し、`--wait-change` を有効化して画面変化を待機する。
3. 実行中に `Ctrl+Alt+P` で一時停止、`Ctrl+Alt+S` で中断。対象ウィンドウのフォーカスが外れたら自動ポーズ。

## 4. 機能要件（Functional Requirements）
### 4.1 入力・制御
- モニタ選択: 1..N から指定し、モニタ矩形情報 (left, top, width, height) を取得。
- キャプチャ対象:
  - 既定: 選択モニタ上のアクティブウィンドウ（70%以上重なり必須）。
  - 代替: モニタ全体。
- 方向指定: left / right（←/→）。
- 回数: 1〜上限（例: 10,000）。上限超過時は確認プロンプト表示。
- 処理順序: shot-first（撮影→送出） / key-first（送出→撮影）。
- 待機設定:
  - 固定ディレイ（秒）。
  - 画面変化待ち（前フレームとの差分検知）＋タイムアウト（秒）。
- ホットキー:
  - `Ctrl+Alt+P`: 一時停止/再開。
  - `Ctrl+Alt+S`: 即時停止。
- 保存先: 任意フォルダ。存在しない場合は作成し、セッションごとにサブフォルダ生成。

### 4.2 キャプチャ
- 解像度: 対象領域のネイティブスケール（DPI を尊重）。
- 形式: 既定 PNG（ロスレス）、オプションで JPEG（品質指定）。
- ファイル名: `session_YYYYMMDD_HHMMSS/page_0001.png`（ゼロパディング）。
- 重複検知: 簡易ハッシュにより連続同一フレームで警告。

### 4.3 自動入力（キー送出）
- キー送出: `VK_LEFT` / `VK_RIGHT` を `SendInput` 同等の方法で送出。
- フォーカス検出: 対象ウィンドウが前面でない場合は送出前に自動ポーズ。
- 失敗時: K 回再試行。継続失敗でエラーダイアログを表示し手動再開待ち。

### 4.4 セッション管理
- モード: 固定回数 / 時間制限 / 手動単発（ワンショット）。
- 状態表示: 進捗 (例: 12/100)、経過時間、最後の保存パス、警告メッセージ。
- 再開: 直前セッションの連番継続オプション。

### 4.5 設定保存
- プロファイル: 直近設定（モニタ、順序、待機、保存先など）をローカル JSON に保存/読込み。
- テンプレート: 複数設定を登録しワンクリックで呼び出し。

## 5. 非機能要件（Non-Functional Requirements）
- オフライン動作（ネットワークアクセス不要）。
- 性能: FHD 領域で 5 枚/秒以上（固定ディレイが許容する範囲で高速化）。
- 安定性: マルチモニタの接続変更や DPI 変更を再認識。
- UX: シングルウィンドウ GUI、プレビューとテストショット、Start/Stop ボタンを大型表示。
- 互換性: 高 DPI スケーリング対応、境界を跨ぐウィンドウの検出。
- ログ: ローカル回転ログ（INFO/ERROR）、個人情報は最小限。

## 6. エラーハンドリング & リカバリ
- 前面ウィンドウなし: ガイダンス表示の上で一時停止。
- 対象ウィンドウの重なり < 70%: 警告を出し一時停止。
- キャプチャ失敗: 自動再試行、継続失敗で停止とリカバリ手順提示。
- 保存失敗（権限/空き容量）: 即停止し別フォルダ選択を促す。
- ホットキー衝突: 起動時に検出し再割り当てを促す。

## 7. セキュリティ / プライバシー
- 完全ローカル処理、外部送信なし。
- 配布時はコード署名を実施。
- ログにフルパス/ウィンドウタイトルを記録しないオプション。
- 設定ファイルはユーザープロファイル配下に保存。

## 8. 設定項目一覧（例）
| 項目 | 型 / 値 | 説明 |
| --- | --- | --- |
| monitor | 整数 (1..N) | 使用モニタ ID |
| mode | `active-window` / `full-monitor` | キャプチャ対象 |
| direction | `left` / `right` | 送出する矢印キー |
| count | 整数 | 撮影回数 |
| delay | 浮動小数 | 固定ディレイ秒数 |
| order | `shot-first` / `key-first` | 操作順序 |
| wait_change | 真偽値 | 画面変化待ちの有無 |
| timeout | 浮動小数 | 画面変化待ちのタイムアウト |
| min_overlap | 0.0〜1.0 | モニタ重なり下限（既定 0.7） |
| output_dir | 文字列 | 保存先フォルダ |
| image_format | `png` / `jpg` | ファイル形式（jpg は `quality` 指定） |
| quality | 0〜100 | JPEG 品質（`image_format=jpg` の場合） |
| hotkeys.pause | 文字列 | 一時停止ホットキー（既定 `Ctrl+Alt+P`） |
| hotkeys.stop | 文字列 | 停止ホットキー（既定 `Ctrl+Alt+S`） |

## 9. 画面構成（UI 案）
- **Capture タブ**
  - モニタ選択ドロップダウン。
  - 対象切替（アクティブウィンドウ / モニタ全体）。
  - ライブプレビュー（領域枠表示）。
  - テストショットボタン。
- **Automation タブ**
  - 方向（← / →）、回数、処理順序。
  - 待機方式（固定ディレイ / 画面変化待ち＋タイムアウト）。
  - 最小重なり率入力。
- **Output タブ**
  - 保存先フォルダ選択、形式（PNG / JPG 品質）。
  - セッション名自動生成 ON/OFF。
- **フッター**
  - Start / Pause / Stop ボタン。
  - 進捗バー、ログパネル（最後の保存ファイル表示）。

## 10. 受入テスト（Acceptance Tests）
- **AT-01**: モニタ 2・アクティブウィンドウ・→・回数 50・delay 0.6 で連番 PNG が作成される。
- **AT-02**: key-first 設定で送出→撮影の順となる。
- **AT-03**: フォーカス喪失時に自動一時停止する。
- **AT-04**: ウィンドウ重なりが 70% 未満で警告→一時停止。
- **AT-05**: wait-change 有効時、変化が無い場合はタイムアウトまで待機後次処理へ。
- **AT-06**: 保存先が書き込み不可なら即停止しエラーメッセージを表示。
- **AT-07**: `Ctrl+Alt+P` でポーズ/再開、`Ctrl+Alt+S` で中断できる。
- **AT-08**: JPG 品質変更が出力に反映される。
- **AT-09**: 設定 JSON の保存/読込が動作する。
- **AT-10**: ログがローカルに出力され、個人情報を含まない設定が選択できる。

## 11. リスク & 対策
- ウィンドウ位置ズレ → 最小重なり閾値設定と自動ポーズで対応。
- 描画遅延によるページ送り失敗 → 画面変化待ちとタイムアウトを用意。
- モニタ DPI 差異 → Per-Monitor DPI 対応で描画を正確に取得。
- 大量保存でのディスク圧迫 → JPG 選択や品質調整、保存先容量警告。
- ホットキー競合 → 起動時の検知と再割り当て UI 提供。

## 12. 導入・運用
- 配布: 単一インストーラ（管理者不要を推奨）。
- 初回起動: チュートリアルとしてプレビュー/テストショットを案内。
- 更新: オフライン想定につき手動更新。

## 13. 将来拡張（Nice-to-have）
- OCR によるページ番号抽出とファイル名/CSV 付与。
- 自動トリミングや台形補正。
- セッション終了時に PDF へ一括結合。
- 領域マスク（ツールバー等を除外）。
- プリセット切替による用途別テンプレート。

## 14. 用語
- **アクティブウィンドウ**: 現在フォーカスを持つウィンドウ。
- **画面変化待ち**: 直前キャプチャとの差分検知で画面更新を確認する仕組み。
